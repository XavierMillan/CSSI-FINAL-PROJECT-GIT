<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <link rel="stylesheet"
    href="A.fonts,,_icomoon,,_style.css+css,,_owl.carousel.min.css+css,,_bootstrap.min.css+css,,_style.css,Mcc.iq-Irt1J63.css.pagespeed.cf.67EAq9-gxU.css">

  <title>Forum</title>
  <style>
    html,
    body {
      height: 150%;
      width: 100%;
      margin: 0;
      padding: 0;
      background-image: linear-gradient(to bottom right, #6ec3f450, #3a3aff50, #ff61ab50, #E6394650);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .card{
      border-radius: 1rem !important;
    }
    p{
      font-weight: normal;
      color: black;
    }
  </style>
</head>




<body>
  <button type="button" class="btn btn-primary openmodal" id="open" style="display: none">Open</button>
  <header class="site-navbar" role="banner">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-11 col-xl-2">
          <h1 class="mb-0 site-logo"><a href="index.html" class="text-black mb-0" style="color:black;">SoC</a></h1>
        </div>
        <div class="col-12 col-md-10 d-none d-xl-block">
          <nav class="site-navigation position-relative text-right" role="navigation">
            <ul class="site-menu js-clone-nav mr-auto d-none d-lg-block">
              <li class=""><a href="index.html" style="color:black;"><span>Home</span></a></li>
              <li><a id='studentNav' style="color:black;" href="progression.html"><span>For
                    Students</span></a></li>
              <li><a id='teachersNav' style="color:black;" href="teachers.html"><span>For
                    Teachers</span></a></li>
              <li><a href="about.html" style="color:black;"><span>About Us</span></a></li>
              <li class="active"><a href="forum.html" style="color:black;"><span>Forum</span></a></li>
              <li><a id="account" href="login.html" style="color:black;"><span>Login</span></a></li>
            </ul>
          </nav>
        </div>
        <div class="d-inline-block d-xl-none ml-md-0 mr-auto py-3" style="position: relative; top: 3px; color:black;"><a
            href="#" class="site-menu-toggle js-menu-toggle text-black active"><span class="icon-menu h3"></span></a>
        </div>
      </div>
    </div>

  </header>

  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <h3 style="display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;">Forum</h3>
  <p style="display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center; color:black">For all things Computer Science related!</p>
  <br>
  <h5 id="messagePane" style="display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center; color: red;"></h5>
  <br>

  <div class="card text-center" id="newPostCard" style="max-width: 60%; margin-left: 20%; display: none">
    <div class="card-header">
      <ul class="nav nav-pills card-header-pills">

        <li class="nav-item">
          <a class="nav-link disabled" href="#">Select Post Type</a>
        </li>

        <li class="nav-item">
          <a class="nav-link active" href="#" id="textnav" onclick="changeCardView('text','image')">Text</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="#" id="imagenav" onclick="changeCardView('image','text')">Image</a>
        </li>

      </ul>
    </div>
    <div class="card-body" id="text">
      <form>
        <div class="form-group">
          <label for="postTitle1">Post Title</label>
          <input type="text" class="form-control" id="postTitle1" placeholder="Title">
        </div>

        <div class="form-group">
          <label for="postContent1">Post Content</label>
          <textarea class="form-control" id="postContent1" rows="3"></textarea>
        </div>

        <label>Categories</label>
<br>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="javascript1" value="Javascript">
  <label class="form-check-label" for="inlineRadio1">Javascript</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="lessonhelp1" value="Lesson Help">
  <label class="form-check-label" for="inlineRadio2">Lesson Help</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="random1" value="Random">
  <label class="form-check-label" for="inlineRadio3">Random</label>
</div>
        <br>
        <br>
        <button type="button" class="btn btn-primary" id="submit1">Post</button>
      </form>
    </div>

    
    <div class="card-body" style="display: none; margin: auto;" id="image">
      <form style="text-align: center;">
        <div class="form-group">
          <label for="postTitle2">Post Title</label>
          <input type="text" class="form-control" id="postTitle2" placeholder="Title">
        </div>

        <div class="form-group">
          <label for="imageUpload">Upload an Image</label>
          <input type="file" style="margin-left: 36% !important;" class="form-control-file" id="imageUpload" accept="image/png, image/gif, image/jpeg, image/jpg">
        </div>

        <label>Categories</label>
<br>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="javascript2" value="Javascript">
  <label class="form-check-label" for="inlineRadio1">Javascript</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="lessonhelp2" value="Lesson Help">
  <label class="form-check-label" for="inlineRadio2">Lesson Help</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="random2" value="Random">
  <label class="form-check-label" for="inlineRadio3">Random</label>
</div>
        <br>
        <br>
        <div class="progress" id="progressdiv" style="display: none">
          <div id="uploader" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100"></div>
        </div>
        <button type="button" class="btn btn-primary" id="submit2">Post</button>
      </form>
    </div>
  </div>


  <!-- Button trigger modal -->


  <!-- Modal -->

  <div class="modal fade" id="postDetailModal" tabindex="-1" role="dialog" aria-labelledby="postDetailModalTitle"
    aria-hidden="true" style="z-index: 9999;" >
    <div  class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content" style="border-radius: 1rem !important;">
        <div class="modal-header">
          <h5 class="modal-title" id="postDetailModalTitle">Post Title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <small id="postDetailModalContact">Contact</small>
          <p class="bold" id="postDetailModalContent">Content</p>
          <img src="https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg" id="postDetailModalIMG"
            style="max-width: 60%; margin-left: 20%; display: none">
          <small id="postDetailModalTime">1pm</small>
          <hr>
          <div id=newComment style="display: none;">
            <form>
              <div class="form-group">
                <!--             <label for="commentText">Post Title</label> -->

                <textarea class="form-control" style="width: 90%" rows="1" id="commentText"
                  placeholder="Comment"></textarea>
                <button style="display: inline-flex;" type="button" class="btn btn-primary" id="submit3">Post</button>
              </div>
            </form>
          </div>
          <div id="postDetailModalComments">



          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <!--         <button type="button" class="btn btn-primary">Save changes</button> -->
        </div>
      </div>
    </div>
  </div>

  <!--     <h1>End of new post card</h1> -->
  <section id="posts">


  </section>


<br>
  <br>
  <br>
  <br>
</body>

<footer class="bg-light" style="padding-top:1rem; padding-bottom:1.5rem">
  <div class="container" style="text-align: center;">
    <a class="text-primary" href="index.html">
      <h5>Home üè†</h5>
    </a>
    <a class="text-primary" href="">
      <h6>Back to top üîù</h6>
    </a>
  </div>
</footer>

<script src="forum.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.9.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>


<script>


  // import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeaWpE9wc6VvPEilrEAqhEnjKo8ik1Stw",
    authDomain: "cssifinal-884f2.firebaseapp.com",
    projectId: "cssifinal-884f2",
    storageBucket: "cssifinal-884f2.appspot.com",
    messagingSenderId: "331915175322",
    appId: "1:331915175322:web:ab968dfdccc693e2094623",
    measurementId: "G-LB249TWWMB"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

// firebase.initializeApp(firebaseConfig);
//   const auth = firebase.auth();
  const db = firebase.firestore();
  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      console.log(user.uid);
      let role = "Student";

      async function getData() {
        var user = firebase.auth().currentUser;
        var userID = user.uid;
        var docRef = db.collection("user-data").doc(userID);
        var doc = await docRef.get();
        if (doc.exists) {
          role = doc.data().role;
          console.log(role);

          // document.getElementById("studentNav").style.display = "none";
          // document.getElementById("teachersNav").style.display = "none";

          console.log(role);

          if (role == "Demo") {
            console.log('Demo');
            document.getElementById("studentNav").style.display = "block";
            document.getElementById("teachersNav").style.display = "block";
            document.getElementById('link').href = 'progression.html';
            document.getElementById('link').innerHTML = "Student Page";
          }
          else if (role == "Teacher") {
            console.log('teacher');
            document.getElementById("studentNav").style.display = "block";
            document.getElementById("teachersNav").style.display = "block";
            document.getElementById('link').href = 'teachers.html';
            document.getElementById('link').innerHTML = "Teacher Page";
          }
          else {
            console.log('student');
            document.getElementById("studentNav").style.display = "block";
            document.getElementById("teachersNav").style.display = "none";
            document.getElementById('link').href = 'progression.html';
            document.getElementById('link').innerHTML = "Student Page";
          }
        }
      }
      getData();
      console.log(document.body.style.display);
      document.body.style.display = "block";
      console.log(document.body.style.display);
      document.getElementById("account").href = "loggedin.html";
      document.getElementById("account").innerHTML = '<span>My Account</span>';

    } else {
      console.log("logged out");
      // });

      document.getElementById("studentNav").style.display = "none";
      document.getElementById("teachersNav").style.display = "none";
    }
  });

  
</script>

<script type="text/javascript">

  //what happens after logged in
  firebase.auth().onAuthStateChanged(function (user) {

    if (user && user.emailVerified) {
      console.log("logged in");
      console.log(user.email);
      document.getElementById("newPostCard").style.display = "block";
      document.getElementById("newComment").style.display = "block";
    }
    else if (user) {
      document.getElementById("messagePane").innerHTML = "To post you must verify your email";
      document.getElementById("newPostCard").style.display = "none";
      document.getElementById("newComment").style.display = "none";
    }
    else {
      console.log("logged out");
      document.getElementById("messagePane").innerHTML = "To post you must be logged in";
      document.getElementById("newPostCard").style.display = "none";
      document.getElementById("newComment").style.display = "none";
    }

    var selectedFile;
    function getfile() {
      var pic = document.getElementById("imageUpload");
      if (pic.files.length > 0) {
        console.log("file found");
        selectedFile = pic.files[0];
        // document.getElementById('submit').setAttribute('disabled', 'true'); 
        return uploadFile();
      }
      else {
        console.log("no file");
      }
    }

    let postImage = "";
    function uploadFile() {
      var name = "" + Date.now();
      var storageRef = firebase.storage().ref('/images/' + name);
      var uploadTask = storageRef.put(selectedFile);

      uploadTask.on('state_changed', function (snapshot) {
        document.getElementById('progressdiv').style.display = 'block';
        document.getElementById('submit2').style.display = 'none';
        var progress =
          (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        var uploader = document.getElementById('uploader');
        uploader.style.width = progress + '%';
        console.log(progress + '%');
        switch (snapshot.state) {
          case firebase.storage.TaskState.PAUSED:
            console.log('Upload is paused');
            break;
          case firebase.storage.TaskState.RUNNING:
            console.log('Upload is running');
            break;
        }

      }, function (error) {
        console.log(error);
        alert(error.message);
      }, function () {
        document.getElementById('uploader').innerHTML = 'Uploaded Sucessfully';
        // get the uploaded image url back 
        uploadTask.snapshot.ref.getDownloadURL().then(
          function (downloadURL) {
            console.log(downloadURL);
            // document.getElementById('submit').removeAttribute('disabled'); 
            postimage = downloadURL;
            getValuesToUpload2();
            // return downloadURL;
          });
      });
      // return "";
    };



    function deletePost(postid) {
      console.log(postid);
      firebase.firestore().collection("posts").doc(postid).delete()
        .then(function () {
          deleteComments(postid);
          console.log("Document successfully deleted!");
          document.getElementById('posts').innerHTML = "";
          getPosts();
        }).catch(function (error) {
          console.error("Error removing document: ", error);
        })
    }

    // function deleteComments(postid){
    //   console.log(postid);
    //   firebase.firestore().collection("comments").doc(postid).delete()
    //     .then(function () {
    //       console.log("Document successfully deleted!");
    //       // document.getElementById('posts').innerHTML = "";
    //       // getPosts();
    //     }).catch(function (error) {
    //       console.error("Error removing document: ", error);
    //     })
    // }

  async function deleteComments(postid) {
    let db = firebase.firestore();
  console.log("delete comments from deleted post");
    // let user = firebase.auth().currentUser;
    const querySnapshot = await firebase.firestore()
        .collectionGroup('comments')
        .get()

      if (!querySnapshot.empty) {
        console.log("not empty");
        for (let doc of querySnapshot.docs) {
          if(doc.data().postid == postid){
            db.collection("comments").doc(doc.id).delete();
            // db.collection("comments").doc(doc.id).delete();
            // doc.update({email: user.email});
            // doc.update({user: user.displayName});
            console.log("comment deleted");
          }
        }
      } 
}



    getPosts = async () => {
      const querySnapshot = await firebase.firestore()
        .collectionGroup('posts')
        .get()

      // let posts = "";
      if (!querySnapshot.empty) {
        for (doc of querySnapshot.docs) {
          console.log(doc.id);
          console.log(doc.data().user + " " + doc.data().uid + " " + doc.data().email);
          console.log(doc.data().title + " " + doc.data().content + " " + doc.data().imageurl);
          console.log(doc.data().upvotes);


          let timestamp = doc.data().timestamp;
          var currentTime = new Date().getTime();
          var difference = currentTime - timestamp;
          var days = Math.floor(difference / (1000 * 60 * 60 * 24));
          var hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          var minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
          var seconds = Math.floor((difference % (1000 * 60)) / 1000);
          let timediff = "";
          if (days != 0) {
            timediff += days + " days ";
          }
          if (hours != 0) {
            timediff += hours + " hours ";
          }
          if (minutes != 0) {
            timediff += minutes + " minutes ";
          }
          timediff += seconds + " seconds ago"
          // let timediff = days + " days " + hours + " hours " + minutes + " minutes " + seconds + " seconds";

          let docid = doc.id + "";
          let uid = doc.data().uid + "";
          let title = doc.data().title;
          let user = doc.data().user;
          let email = doc.data().email;
          let content = doc.data().content;
          let imageurl = doc.data().imageurl;
          let category = doc.data().category;
          let deleteButtonHTML = ``;

          if (firebase.auth().currentUser) {
            if (firebase.auth().currentUser.uid == doc.data().uid) {
              console.log("match");
              deleteButtonHTML = `<button type="button" class="btn btn-danger delete" data-docid=${docid}>Delete</button>`;
            }
            console.log(firebase.auth().currentUser.uid, doc.data().uid);
            console.log(deleteButtonHTML);
          }
//https://cssi-main.xavim1.repl.co/forum.html?postid=

          if (imageurl.length < 10) {
            var xmlString = `
    <br>
    <div class="card" style="width: 60%; margin-left: 20%;" id="${docid}" data-uid="${uid}" data-docid="${docid}">
      <div class="card-body">
        <h5 class="card-title">${title}</h5>
        <small class="text-muted">${category}</small>
        <br>
        <small class="text-muted">${user} - ${email}</small>
        <p class="card-text">${content}</p>
        <hr>
        <button type="button" class="btn btn-primary openmodal" id="${docid}">Comments</button>
        <button type="button" class="btn btn-secondary share" onclick="navigator.clipboard.writeText('https://cssi-main.xavim1.repl.co/forum.html?postid=${docid}');">Share</button>
        ${deleteButtonHTML}
        <br>
        <p class="card-text"><small class="text-muted">${timediff}</small></p>
      </div>
    </div>
    `;

            var d1 = document.getElementById('posts');
            d1.insertAdjacentHTML('afterbegin', xmlString);
            document.getElementById('postContent1').value = '';
            document.getElementById('postTitle1').value = '';
            console.log("html added");

          } else {
            var xmlString = `
        <br>
        <div class="card" style="width: 60%; margin-left: 20% ;" id="${docid}" data-uid="${uid}">
        <img class="card-img-top" style="max-height: 10%; width: auto; margin-left: 25%; margin-right: 25%;" src="${imageurl}" alt="Card image cap">
          <div class="card-body">
            <h5 class="card-title">${title}</h5>
            <small class="text-muted">${category}</small>
            <br>
            <small class="text-muted">${user} - ${email}</small>
          <br>
          <br>
        <hr>
        <button type="button" class="btn btn-primary openmodal" id="${docid}">Comments</button>
         <button type="button" class="btn btn-secondary share" onclick="navigator.clipboard.writeText('https://cssi-main.xavim1.repl.co/forum.html?postid=${docid}');">Share</button>
        
        ${deleteButtonHTML}
        <p class="card-text"><small class="text-muted">${timediff}</small></p>
        </div>
        </div>
        `;
            document.getElementById('progressdiv').style.display = 'none';
            document.getElementById('submit2').style.display = 'block';
            document.getElementById('uploader').style.width = '0%';

            document.getElementById('imageUpload').value = '';
            document.getElementById('postTitle2').value = '';
            var d1 = document.getElementById('posts');
            d1.insertAdjacentHTML('afterbegin', xmlString);


          }



      }
        // return posts;
        let openModal = document.getElementsByClassName('openmodal');
        console.log(openModal.length);
        for (let i = 0; i < openModal.length; i++) {
          openModal[i].addEventListener('click', (e) => {
            // data-docid="${docid}"
            //get the id of the button that was clicked
            let id = e.target.id;
            console.log("clicked" + id);
            setModal(id);
            $("#postDetailModal").modal()
            //get the id of the button
            //  let id = e.target.id;
            // //get data-docid from the button
            //  let docId = e.target.dataset.docid;
            //  console.log(docId);

          });
          
        }
        
          var url = new URL(window.location.href);
    var postidparam = url.searchParams.get("postid");
    if(postidparam != null && postidparam.length > 5) {
      console.log(postidparam);
        setModal(postidparam);
         el = document.getElementById('open');
if (el.onclick) {
   el.onclick();
} else if (el.click) {
   el.click();
}
      
    }
       
        


        let deleteButtons = document.getElementsByClassName('delete');
        console.log(deleteButtons.length);
        for (let i = 0; i < deleteButtons.length; i++) {
          deleteButtons[i].addEventListener('click', (e) => {
            //get data-docid from button
            let docidv = e.target.dataset.docid;
            console.log(docidv + "");
            // slice(0, -2);
            //delete post
            deletePost(docidv);
          });
        }


      }
      else {
        console.log('empty')
        return null;
      }
    }

    getPosts();

    function addToPosts(title, content, imageurl) {
      let username = user.displayName;
      let useremail = user.email;
      console.log(user.email);
      let uid = user.uid;
      let time = Date.now();
      let category = document.querySelector('input[name="inlineRadioOptions"]:checked').value;
      console.log(category);
      firebase.firestore().collection('posts').doc(time + "." + uid).set({
        user: username,
        email: useremail,
        uid: uid,
        title: title,
        content: content,
        imageurl: imageurl,
        upvotes: 0,
        timestamp: time,
        category: category
      }).then(function () {
        console.log("post added!")
        getPosts();
      }).catch(function (error) {
        console.log(error);
      });

    }

    document.getElementById("submit1").addEventListener('click', function () {
      document.getElementById('posts').innerHTML = "";
      console.log(document.getElementById('postContent1').value);
      getValuesToUpload1();
    });

    function getValuesToUpload1() {
      console.log(user.email);
      if (user && document.getElementById('postTitle1').value != "" && document.getElementById('postContent1').value != "") {
        addToPosts(document.getElementById('postTitle1').value, document.getElementById('postContent1').value, " ");
        console.log('upload post1');
      }
    };

    document.getElementById("submit2").addEventListener('click', function () {
      document.getElementById('posts').innerHTML = "";
      postimage = "";
      if (imageUpload.files.length > 0) {
        postimage = getfile();
      }
      else {
        getValuesToUpload2();
      }
    });

    function getValuesToUpload2() {
      if (user && document.getElementById('postTitle2').value != "") {
        addToPosts(document.getElementById('postTitle2').value, " ", postimage);
        console.log('upload post 2');
      }
    }

    /*
    postDetailModalTitle
    <small id="postDetailModalContact"></small>
            <p id="postDetailModalContent"></p>
            <img id="postDetailModalIMG">
            <small id="postDetailModalTime"></small>
            <div id="postDetailModalComments">
              
            </div>
      */
   


  setModal = async (docid) => {
      const querySnapshot = await firebase.firestore()
        .collection("posts")
        .doc(docid)
        .get()

      // let posts = "";
      if (!querySnapshot.empty) {
        console.log(querySnapshot.id);
        document.getElementById("postDetailModalTitle").innerHTML = querySnapshot.data().title;
        document.getElementById("postDetailModalContent").innerHTML = querySnapshot.data().content;
        document.getElementById("postDetailModalContact").innerHTML = querySnapshot.data().user + " - " + querySnapshot.data().email;
        if (querySnapshot.data().imageurl.length > 10) {
          document.getElementById("postDetailModalIMG").src = querySnapshot.data().imageurl;
          document.getElementById("postDetailModalIMG").style.display = "block";
        }
        else {
          document.getElementById("postDetailModalIMG").style.display = "none";
        }
        //postDetailModalIMG


        let timestamp = querySnapshot.data().timestamp;
        var currentTime = new Date().getTime();
        var difference = currentTime - timestamp;
        var days = Math.floor(difference / (1000 * 60 * 60 * 24));
        var hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((difference % (1000 * 60)) / 1000);
        let timediff = "";
        if (days != 0) {
          timediff += days + " days ";
        }
        if (hours != 0) {
          timediff += hours + " hours ";
        }
        if (minutes != 0) {
          timediff += minutes + " minutes ";
        }
        timediff += seconds + " seconds ago"
        console.log(timediff);
        document.getElementById("postDetailModalTime").innerHTML = timediff;
        document.getElementById('submit3').dataset.postid = querySnapshot.id;

        getComments(querySnapshot.id);





      }
      else {
        console.log('empty')
        return null;
      }
    }

function deleteComment(docid, post) {
      console.log(docid);
      firebase.firestore().collection("comments").doc(docid).delete()
        .then(function () {
          console.log("Document successfully deleted!");
          document.getElementById('postDetailModalComments').innerHTML = "";
          getComments(post);
        }).catch(function (error) {
          console.error("Error removing document: ", error);
        })
    }

    //comment mechanics    
    getComments = async (post) => {
      document.getElementById('postDetailModalComments').innerHTML = "";
      const querySnapshot = await firebase.firestore()
        .collectionGroup('comments')
        .where("postid", "==", post)
        .get()

      // let posts = "";
      if (!querySnapshot.empty) {
        for (doc of querySnapshot.docs) {
          console.log(doc.id);
          console.log(doc.data().user + " " + doc.data().uid + " " + doc.data().email);
          console.log(doc.data().content);
          console.log(doc.data().postid);


          let deleteButtonComHTML = ``;

          if (firebase.auth().currentUser) {
            if (firebase.auth().currentUser.uid == doc.data().uid) {
              console.log("match");
              deleteButtonComHTML = `<button type="button" class="btn btn-danger deleteCom" data-docid=${doc.id}>Delete</button>`;
            }
            console.log(firebase.auth().currentUser.uid, doc.data().uid);
            console.log(deleteButtonComHTML);
          }

          
          // console.log(doc.data().timestamp);
          console.log(doc.data().upvotes);
          let commentContact = doc.data().user + " - " + doc.data().email;
          let commentContent = doc.data().content;

          let commentXML = `<div>
            <small>${commentContact}</small>
            <p> ${commentContent} </p>
            ${deleteButtonComHTML}
          </div>`;
          console.log(commentXML);
          var d2 = document.getElementById('postDetailModalComments');
          d2.insertAdjacentHTML('afterbegin', commentXML);

        }// return posts;

        let deleteButtonsCom = document.getElementsByClassName('deleteCom');
        console.log(deleteButtonsCom.length);
        for (let i = 0; i < deleteButtonsCom.length; i++) {
          deleteButtonsCom[i].addEventListener('click', (e) => {
            //get data-docid from button
            let docidv = e.target.dataset.docid;
            console.log(docidv + "");
            // slice(0, -2);
            //delete post
            deleteComment(docidv, post);
          });
        }

      }
      else {
        document.getElementById('postDetailModalComments').innerHTML = "<p>No Comments</p>";
        console.log('empty')
        return null;
      }
    }

    // document.getElementById("findcomments").addEventListener('click', function(){
    //   let query = document.getElementById("postidSearch").value;
    //   getComments(query);
    //   console.log("Comments Found");

    // });

    document.getElementById('submit3').addEventListener('click', (e) => {
      let docIdData = e.target.dataset.postid;
      console.log(docIdData);
      let commentValue = document.getElementById('commentText').value;
      console.log(commentValue);
      addToComments(commentValue, docIdData);

    });

    function addToComments(content, postid) {
      // TODO: remove uidSAMPLE
      let userName = user.displayName;
      let userEmail = user.email;
      let userID = user.uid;
      let time = Date.now();
      firebase.firestore().collection('comments').doc(time + "." + userID).set({
        user: userName,
        email: userEmail,
        uid: userID,
        content: content,
        postid: postid,
        upvotes: 0,
        timestamp: time
      }).then(function () {
        getComments(postid);
        console.log("comment added!");

        // getposts();
      }).catch(function (error) {
        document.getElementById('commentText').value = "";

        console.log(error);
      });

    }

    // document.getElementById("submitc").addEventListener('click', function(){
    //   if(document.getElementById('nameINC').value!="" && document.getElementById('emailINC').value!="" && document.getElementById('contentINC').value!=""&& document.getElementById('postid').value!=""){
    // addToComments(document.getElementById('nameINC').value, document.getElementById('emailINC').value, 11111111, document.getElementById('contentINC').value, document.getElementById('postid').value);
    // console.log('add comment');
    // }
    // });

    //   } else{
    //   console.log("logged out");
    //   document.getElementById("newPostCard").style.display ="none";
    // }
  });


</script>


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
  integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
  integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<!-- Production version -->
<!-- <script src="https://unpkg.com/@popperjs/core@2"></script> -->

<!-- <script>
  $(function() {
  $('[data-toggle="popover"]').popover({
		html: true,
    content: function() {
      return $('#popover-content').html();
    }
  });
})
</script> -->

</html>